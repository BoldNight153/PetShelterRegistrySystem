openapi: 3.1.0
info:
  title: Auth REST API
  version: 0.1.0
  x-ci-updated: "2025-11-16T00:00:00Z"
  description: >-
    Authentication and session endpoints for the Pet Shelter Registry System.
    Uses cookie-based JWT access tokens and rotating refresh tokens with double-submit CSRF protection.
    
    Tips:
    - Use the servers dropdown to switch between same-origin ("/") and an absolute host.
    - Code samples use relative URLs so requests target the selected server's base.
  license:
    name: MIT
    url: "https://opensource.org/licenses/MIT"
servers:
  - url: "/"
    description: Same-origin (recommended for deployed environments)
  - url: "{scheme}://{host}"
    description: Absolute template for non-same-origin testing
    variables:
      scheme:
        enum: [http, https]
        default: http
      host:
        default: localhost:4000
security: []
tags:
  - name: Auth
    description: Email/password auth, tokens, and diagnostics
  - name: Security
    description: Account security snapshot, MFA, and active sessions
  - name: Notifications
    description: Notification preferences, digests, quiet hours, escalations, and devices
components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: accessToken
      description: JWT access token issued by /auth/login or after verification/reset
    csrfHeader:
      type: apiKey
      in: header
      name: x-csrf-token
      description: Required for state-changing requests; value must match the csrfToken cookie
  responses:
    AuthSuccess:
      description: >-
        Successful authentication. For browser flows the server typically sets cookies and may
        redirect; API clients may receive this JSON body directly. The payload shape is shared by
        email/password login and OAuth callback flows.
      headers:
        Set-Cookie:
          description: >-
            Sets two HttpOnly cookies on successful authentication:
            - accessToken: short-lived JWT used for API authorization (HttpOnly, SameSite=Lax, Path=/, Secure in production)
            - refreshToken: opaque token used to rotate sessions (HttpOnly, SameSite=Lax, Path=/, Secure in production, Max-Age set)
            Multiple Set-Cookie headers will be present in the response.
          schema:
            type: string
          examples:
            accessCookie:
              summary: accessToken cookie
              value: accessToken=eyJhbGciOi...; Path=/; HttpOnly; SameSite=Lax; Secure
            refreshCookie:
              summary: refreshToken cookie
              value: refreshToken=4f6b0d9e...; Max-Age=2592000; Path=/; HttpOnly; SameSite=Lax; Secure
      content:
        application/json:
          schema:
            type: object
            properties:
              ok: { type: boolean, description: Indicates the authentication succeeded }
              provider:
                type: string
                enum: [password, google, github]
                description: Authentication provider
              user:
                type: object
                description: Authenticated user summary
                properties:
                  id: { type: string }
                  email: { type: string }
                  name: { type: ["string", "null"] }
                  emailVerified: { type: ["string", "null"], format: date-time }
                required: [id, email]
              roles:
                type: array
                items: { type: string }
                description: Assigned roles for the authenticated user
              permissions:
                type: array
                items: { type: string }
                description: Effective permissions for the authenticated user
              redirect:
                type: ["string", "null"]
                format: uri
                description: Optional URL to navigate to after successful login
              created:
                type: boolean
                description: True if a new user account was created during this flow
              linked:
                type: boolean
                description: True if an existing user account was linked to this provider
            required: [ok, provider, user]
          example:
            ok: true
            provider: password
            user:
              id: "7be82153-7c1a-4823-abff-49f2003cfb0b"
              email: "admin@example.com"
              name: "Admin"
              emailVerified: "2025-10-15T10:37:44.000Z"
            roles: ["user"]
            permissions: ["pets:read", "owners:read"]
            redirect: null
            created: false
            linked: false
    TooManyRequests:
      description: Too Many Requests
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
    Forbidden:
      description: Authenticated but action is not allowed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
  schemas:
    ErrorEnvelope:
      type: object
      properties:
        error:
          oneOf:
            - type: string
            - type: object
      required: [error]
    SecurityRiskAlert:
      type: object
      properties:
        id: { type: string }
        message: { type: string }
        severity:
          type: string
          enum: [info, warning, critical]
        createdAt:
          type: string
          format: date-time
        acknowledgedAt:
          type: ["string", "null"]
          format: date-time
      required: [id, message, severity, createdAt]
    SecurityOverview:
      type: object
      properties:
        score: { type: integer, minimum: 0, maximum: 100 }
        tier:
          type: string
          enum: [low, medium, high]
        summary: { type: string }
        lastPasswordChange:
          type: ["string", "null"]
          format: date-time
        passwordHealth:
          type: string
          enum: [unknown, weak, fair, strong]
        mfaEnabled: { type: boolean }
        trustedDevices: { type: integer, minimum: 0 }
        untrustedDevices: { type: integer, minimum: 0 }
        pendingAlerts: { type: integer, minimum: 0 }
        lastAnomalyAt:
          type: ["string", "null"]
          format: date-time
        riskAlerts:
          type: array
          items: { $ref: '#/components/schemas/SecurityRiskAlert' }
      required: [score, tier, summary, passwordHealth, mfaEnabled, trustedDevices, untrustedDevices, pendingAlerts, riskAlerts]
    SecurityPasswordPolicy:
      type: object
      properties:
        minLength: { type: integer, minimum: 6 }
        requireUppercase: { type: boolean }
        requireLowercase: { type: boolean }
        requireNumber: { type: boolean }
        requireSymbol: { type: boolean }
        expiryDays:
          type: ["integer", "null"]
          minimum: 0
        historyCount: { type: integer, minimum: 0 }
        minScore: { type: integer, minimum: 0 }
      required: [minLength, requireUppercase, requireLowercase, requireNumber, requireSymbol, historyCount, minScore]
    SecurityPasswordHistoryEntry:
      type: object
      properties:
        id: { type: string }
        changedAt:
          type: string
          format: date-time
        location:
          type: ["string", "null"]
        client:
          type: ["string", "null"]
      required: [id, changedAt]
    SecurityPasswordSettings:
      type: object
      properties:
        policy: { $ref: '#/components/schemas/SecurityPasswordPolicy' }
        history:
          type: array
          items: { $ref: '#/components/schemas/SecurityPasswordHistoryEntry' }
      required: [policy, history]
    SecurityHardwareKey:
      type: object
      properties:
        id: { type: string }
        label: { type: string }
        addedAt:
          type: ["string", "null"]
          format: date-time
        lastUsedAt:
          type: ["string", "null"]
          format: date-time
        transports:
          type: array
          items: { type: string }
      required: [id, label]
    SecurityMfaFactor:
      type: object
      properties:
        id: { type: string }
        type:
          type: string
          enum: [totp, sms, push, hardware_key, backup_codes]
        label: { type: string }
        enabled: { type: boolean }
        status:
          type: string
          enum: [pending, active, disabled, revoked]
        enrolledAt:
          type: ["string", "null"]
          format: date-time
        lastUsedAt:
          type: ["string", "null"]
          format: date-time
        devices:
          type: array
          items: { $ref: '#/components/schemas/SecurityHardwareKey' }
        remainingCodes:
          type: ["integer", "null"]
        metadata:
          description: Arbitrary MFA metadata
  required: [id, type, label, enabled, status]
    SecurityMfaRecommendation:
      type: object
      properties:
        type:
          type: string
          enum: [totp, sms, push, hardware_key, backup_codes]
        reason: { type: string }
      required: [type, reason]
    SecuritySession:
      type: object
      properties:
        id: { type: string }
        device: { type: string }
        platform:
          type: ["string", "null"]
        browser:
          type: ["string", "null"]
        ipAddress:
          type: ["string", "null"]
        location:
          type: ["string", "null"]
        createdAt:
          type: string
          format: date-time
        lastActiveAt:
          type: string
          format: date-time
        trusted: { type: boolean }
        current: { type: boolean }
        risk:
          type: string
          enum: [low, medium, high, unknown]
      required: [id, device, createdAt, lastActiveAt, trusted, current, risk]
    SecuritySessionSummary:
      type: object
      properties:
        activeCount: { type: integer, minimum: 0 }
        trustedCount: { type: integer, minimum: 0 }
        lastRotationAt:
          type: ["string", "null"]
          format: date-time
        lastUntrustedAt:
          type: ["string", "null"]
          format: date-time
      required: [activeCount, trustedCount]
    SecurityRecoveryChannel:
      type: object
      properties:
        type:
          type: string
          enum: [email, sms]
        value: { type: string }
        verified: { type: boolean }
        lastVerifiedAt:
          type: ["string", "null"]
          format: date-time
      required: [type, value, verified]
    SecurityBreakGlassContact:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        email: { type: string }
        phone:
          type: ["string", "null"]
        verified: { type: boolean }
      required: [id, name, email, verified]
    SecurityRecoverySettings:
      type: object
      properties:
        primaryEmail: { $ref: '#/components/schemas/SecurityRecoveryChannel' }
        backupEmail:
          $ref: '#/components/schemas/SecurityRecoveryChannel'
        sms:
          $ref: '#/components/schemas/SecurityRecoveryChannel'
        backupCodesRemaining: { type: integer, minimum: 0 }
        lastCodesGeneratedAt:
          type: ["string", "null"]
          format: date-time
        contacts:
          type: array
          items: { $ref: '#/components/schemas/SecurityBreakGlassContact' }
      required: [primaryEmail, backupCodesRemaining, contacts]
    SecurityPasswordChangeRequest:
      type: object
      properties:
        currentPassword:
          type: string
          format: password
        newPassword:
          type: string
          format: password
          minLength: 8
        signOutOthers:
          type: boolean
          description: When true, revoke other refresh-token sessions after the password rotates
      required: [currentPassword, newPassword]
    SecurityAlertPreference:
      type: object
      properties:
        event: { type: string }
        label: { type: string }
        enabled: { type: boolean }
        channels:
          type: array
          items:
            type: string
            enum: [email, sms, push, in_app]
      required: [event, label, enabled, channels]
    SecurityAlertSettings:
      type: object
      properties:
        preferences:
          type: array
          items: { $ref: '#/components/schemas/SecurityAlertPreference' }
        defaultChannels:
          type: array
          items:
            type: string
            enum: [email, sms, push, in_app]
      required: [preferences, defaultChannels]
    SecurityEventEntry:
      type: object
      properties:
        id: { type: string }
        action: { type: string }
        description: { type: string }
        severity:
          type: string
          enum: [info, warning, critical]
        createdAt:
          type: string
          format: date-time
        ipAddress:
          type: ["string", "null"]
        location:
          type: ["string", "null"]
        metadata:
          description: Additional context for the event
      required: [id, action, description, severity, createdAt]
    AccountSecuritySnapshot:
      type: object
      properties:
        overview: { $ref: '#/components/schemas/SecurityOverview' }
        password: { $ref: '#/components/schemas/SecurityPasswordSettings' }
        mfa:
          type: object
          properties:
            factors:
              type: array
              items: { $ref: '#/components/schemas/SecurityMfaFactor' }
            recommendations:
              type: array
              items: { $ref: '#/components/schemas/SecurityMfaRecommendation' }
          required: [factors, recommendations]
        sessions:
          type: object
          properties:
            summary: { $ref: '#/components/schemas/SecuritySessionSummary' }
            list:
              type: array
              items: { $ref: '#/components/schemas/SecuritySession' }
          required: [summary, list]
        recovery: { $ref: '#/components/schemas/SecurityRecoverySettings' }
        alerts: { $ref: '#/components/schemas/SecurityAlertSettings' }
        events:
          type: array
          items: { $ref: '#/components/schemas/SecurityEventEntry' }
      required: [overview, password, mfa, sessions, recovery, alerts, events]
    SecuritySessionsResponse:
      type: object
      properties:
        summary: { $ref: '#/components/schemas/SecuritySessionSummary' }
        sessions:
          type: array
          items: { $ref: '#/components/schemas/SecuritySession' }
      required: [summary, sessions]
    SecuritySessionRevokeRequest:
      type: object
      properties:
        sessionId: { type: string, description: Refresh token identifier }
      required: [sessionId]
    SecuritySessionTrustRequest:
      type: object
      properties:
        sessionId: { type: string, description: Refresh token identifier }
        trust:
          type: boolean
          description: When true mark device trusted; when false clear trust
      required: [sessionId]
    SecurityTotpEnrollRequest:
      type: object
      properties:
        label:
          type: string
          description: Friendly label for the authenticator entry
        issuer:
          type: string
          description: Issuer shown in authenticator apps
        accountName:
          type: string
          description: Account identifier for key URI (defaults to email)
    SecurityTotpConfirmRequest:
      type: object
      properties:
        ticket: { type: string }
        code:
          type: string
          minLength: 6
          maxLength: 12
      required: [ticket, code]
    SecurityTotpEnrollmentPrompt:
      type: object
      properties:
        ticket: { type: string }
        factorId: { type: string }
        mode:
          type: string
          enum: [create, rotate]
        type:
          type: string
          enum: [totp]
        secret: { type: string }
        uri: { type: string }
        qrCodeDataUrl: { type: string }
        expiresAt:
          type: string
          format: date-time
      required: [ticket, factorId, mode, type, secret, uri]
    SecurityTotpEnrollmentResult:
      type: object
      properties:
        factor: { $ref: '#/components/schemas/SecurityMfaFactor' }
        backupCodes:
          type: array
          items: { type: string }
        expiresAt:
          type: ["string", "null"]
          format: date-time
      required: [factor, backupCodes]
    SecurityBackupCodeRegenerateRequest:
      type: object
      properties:
        factorId:
          type: string
          description: Optional MFA factor ID to scope code regeneration
    SecurityBackupCodeResponse:
      type: object
      properties:
        codes:
          type: array
          items: { type: string }
        expiresAt:
          type: ["string", "null"]
          format: date-time
      required: [codes]
    NotificationChannel:
      type: string
      enum: [email, sms, push, in_app]
    NotificationTopicCategory:
      type: string
      enum: [account, animals, operations, security, system]
    NotificationTopicPreference:
      type: object
      properties:
        id: { type: string }
        label: { type: string }
        description:
          type: ["string", "null"]
        category: { $ref: '#/components/schemas/NotificationTopicCategory' }
        enabled: { type: boolean }
        channels:
          type: array
          minItems: 1
          maxItems: 4
          items: { $ref: '#/components/schemas/NotificationChannel' }
        critical:
          type: ["boolean", "null"]
        muteUntil:
          type: ["string", "null"]
          format: date-time
      required: [id, label, category, enabled, channels]
    NotificationDigestSettings:
      type: object
      properties:
        enabled: { type: boolean }
        frequency:
          type: string
          enum: [daily, weekly]
        sendHourLocal:
          type: integer
          minimum: 0
          maximum: 23
        timezone:
          type: ["string", "null"]
        includeSummary: { type: boolean }
      required: [enabled, frequency, sendHourLocal, includeSummary]
    NotificationQuietHours:
      type: object
      properties:
        enabled: { type: boolean }
        startHour:
          type: integer
          minimum: 0
          maximum: 23
        endHour:
          type: integer
          minimum: 0
          maximum: 23
        timezone:
          type: ["string", "null"]
      required: [enabled, startHour, endHour]
    NotificationCriticalEscalations:
      type: object
      properties:
        smsFallback: { type: boolean }
        backupEmail:
          type: ["string", "null"]
          format: email
        pagerDutyWebhook:
          type: ["string", "null"]
          format: uri
      required: [smsFallback]
    NotificationDevice:
      type: object
      properties:
        id: { type: string }
        label: { type: string }
        platform:
          type: string
          enum: [ios, android, web, unknown]
        enabled: { type: boolean }
        lastUsedAt:
          type: ["string", "null"]
          format: date-time
      required: [id, label, platform, enabled]
    NotificationSettings:
      type: object
      properties:
        defaultChannels:
          type: array
          minItems: 1
          maxItems: 4
          items: { $ref: '#/components/schemas/NotificationChannel' }
        topics:
          type: array
          minItems: 1
          maxItems: 50
          items: { $ref: '#/components/schemas/NotificationTopicPreference' }
        digests: { $ref: '#/components/schemas/NotificationDigestSettings' }
        quietHours: { $ref: '#/components/schemas/NotificationQuietHours' }
        criticalEscalations: { $ref: '#/components/schemas/NotificationCriticalEscalations' }
        devices:
          type: array
          maxItems: 25
          items: { $ref: '#/components/schemas/NotificationDevice' }
      required: [defaultChannels, topics, digests, quietHours, criticalEscalations, devices]
    NotificationSettingsUpdateRequest:
      type: object
      properties:
        defaultChannels:
          type: array
          minItems: 1
          maxItems: 4
          items: { $ref: '#/components/schemas/NotificationChannel' }
        topics:
          type: array
          minItems: 1
          maxItems: 50
          items: { $ref: '#/components/schemas/NotificationTopicPreference' }
        digests: { $ref: '#/components/schemas/NotificationDigestSettings' }
        quietHours: { $ref: '#/components/schemas/NotificationQuietHours' }
        criticalEscalations: { $ref: '#/components/schemas/NotificationCriticalEscalations' }
        devices:
          type: array
          maxItems: 25
          items: { $ref: '#/components/schemas/NotificationDevice' }
paths:
  /auth/csrf:
    get:
      tags: [Auth]
      summary: Issue CSRF token
      description: Returns a CSRF token and sets a non-HttpOnly csrfToken cookie for double-submit protection.
      operationId: getCsrf
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  csrfToken: { type: string }
                required: [csrfToken]
              example:
                csrfToken: "abc.def"
        "400": { $ref: "#/components/responses/BadRequest" }
        "429": { $ref: "#/components/responses/TooManyRequests" }
      x-codeSamples:
        - lang: curl
          label: curl
          source: |
            # Uses same-origin; adjust if calling from outside the app
            curl -s /auth/csrf | jq

  /auth/security:
    get:
      tags: [Security]
      summary: Get the signed-in user's security snapshot
      description: >-
        Returns derived password health, MFA enrollment, recovery contacts, alert
        preferences, session summary, and the most recent security events for the
        authenticated user. Requires a valid `accessToken` cookie.
      operationId: getAccountSecuritySnapshot
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Account security snapshot
          content:
            application/json:
              schema:
                type: object
                properties:
                  snapshot:
                    $ref: '#/components/schemas/AccountSecuritySnapshot'
                required: [snapshot]
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/security/sessions:
    get:
      tags: [Security]
      summary: List active sessions for the signed-in user
      description: Returns trusted and untrusted sessions based on refresh token metadata.
      operationId: getAccountSecuritySessions
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Active sessions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecuritySessionsResponse'
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/security/sessions/revoke:
    post:
      tags: [Security]
      summary: Revoke a specific session
      description: Revokes a refresh-token session belonging to the signed-in user. Requires CSRF header.
      operationId: revokeAccountSecuritySession
      security:
        - cookieAuth: []
          csrfHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SecuritySessionRevokeRequest'
      responses:
        "204": { description: Session revoked }
        "400": { $ref: '#/components/responses/BadRequest' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "404": { $ref: '#/components/responses/NotFound' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/security/sessions/revoke-all:
    post:
      tags: [Security]
      summary: Revoke all other sessions
      description: Revokes every refresh-token session for the user (optionally excluding the current cookie holder).
      operationId: revokeAllAccountSecuritySessions
      security:
        - cookieAuth: []
          csrfHeader: []
      responses:
        "204": { description: Sessions revoked }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/security/sessions/trust:
    post:
      tags: [Security]
      summary: Mark a session's device as trusted or untrusted
      description: Updates trust metadata for the device backing a refresh-token session.
      operationId: trustAccountSecuritySession
      security:
        - cookieAuth: []
          csrfHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SecuritySessionTrustRequest'
      responses:
        "204": { description: Session trust updated }
        "400": { $ref: '#/components/responses/BadRequest' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "404": { $ref: '#/components/responses/NotFound' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/security/password:
    post:
      tags: [Security]
      summary: Change the signed-in user's password
      description: |
        Rotate the authenticated user's password while enforcing the same complexity requirements as registration,
        checking password history, and optionally revoking other refresh-token sessions. Requires a valid session
        plus CSRF header.
      operationId: changeAccountSecurityPassword
      security:
        - cookieAuth: []
          csrfHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SecurityPasswordChangeRequest'
      responses:
        "204": { description: Password updated }
        "400": { $ref: '#/components/responses/BadRequest' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/security/recovery:
    put:
      tags: [Security]
      summary: Update recovery channels and contacts
      description: |
        Update the signed-in user's recovery email, SMS channel, backup codes metadata,
        and break-glass contacts. Requires a valid session cookie plus CSRF header.
      operationId: updateAccountSecurityRecovery
      security:
        - cookieAuth: []
          csrfHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SecurityRecoverySettings'
      responses:
        "200":
          description: Updated recovery settings
          content:
            application/json:
              schema:
                type: object
                properties:
                  recovery:
                    $ref: '#/components/schemas/SecurityRecoverySettings'
                required: [recovery]
        "400": { $ref: '#/components/responses/BadRequest' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/security/alerts:
    put:
      tags: [Security]
      summary: Update alert preferences
      description: |
        Persist the signed-in user's personal security alert preferences and default channels.
        Requires a valid session cookie plus CSRF header.
      operationId: updateAccountSecurityAlerts
      security:
        - cookieAuth: []
          csrfHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SecurityAlertSettings'
      responses:
        "200":
          description: Updated alert preferences
          content:
            application/json:
              schema:
                type: object
                properties:
                  alerts:
                    $ref: '#/components/schemas/SecurityAlertSettings'
                required: [alerts]
        "400": { $ref: '#/components/responses/BadRequest' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/security/mfa/totp/enroll:
    post:
      tags: [Security]
      summary: Start TOTP enrollment
      description: Generates a TOTP secret, QR code, and short-lived ticket for the signed-in user.
      operationId: startTotpEnrollment
      security:
        - cookieAuth: []
          csrfHeader: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SecurityTotpEnrollRequest'
      responses:
        "200":
          description: Enrollment prompt
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecurityTotpEnrollmentPrompt'
        "400": { $ref: '#/components/responses/BadRequest' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/security/mfa/totp/confirm:
    post:
      tags: [Security]
      summary: Confirm TOTP enrollment
      description: Verifies a TOTP code using the pending ticket and persists the factor plus backup codes.
      operationId: confirmTotpEnrollment
      security:
        - cookieAuth: []
          csrfHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SecurityTotpConfirmRequest'
      responses:
        "200":
          description: Enrollment confirmed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecurityTotpEnrollmentResult'
        "400": { $ref: '#/components/responses/BadRequest' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "404": { $ref: '#/components/responses/NotFound' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/security/mfa/totp/{factorId}/regenerate:
    post:
      tags: [Security]
      summary: Rotate an existing TOTP factor
      description: Creates a new secret and ticket for an existing TOTP factor so the user can re-enroll the authenticator.
      operationId: regenerateTotpFactor
      security:
        - cookieAuth: []
          csrfHeader: []
      parameters:
        - in: path
          name: factorId
          required: true
          schema: { type: string }
          description: Identifier of the factor returned from the security snapshot
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SecurityTotpEnrollRequest'
      responses:
        "200":
          description: Rotation prompt
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecurityTotpEnrollmentPrompt'
        "400": { $ref: '#/components/responses/BadRequest' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "404": { $ref: '#/components/responses/NotFound' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/security/mfa/backup-codes/regenerate:
    post:
      tags: [Security]
      summary: Regenerate backup codes
      description: Issues a fresh set of single-use backup codes tied to one of the user's active MFA factors.
      operationId: regenerateBackupCodes
      security:
        - cookieAuth: []
          csrfHeader: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SecurityBackupCodeRegenerateRequest'
      responses:
        "200":
          description: Backup codes regenerated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SecurityBackupCodeResponse'
        "400": { $ref: '#/components/responses/BadRequest' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/security/mfa/{factorId}/disable:
    post:
      tags: [Security]
      summary: Disable an MFA factor
      description: Marks a specific MFA factor (e.g., TOTP) as disabled for the signed-in user.
      operationId: disableMfaFactor
      security:
        - cookieAuth: []
          csrfHeader: []
      parameters:
        - in: path
          required: true
          name: factorId
          schema: { type: string }
          description: Identifier returned in the security snapshot
      responses:
        "204": { description: Factor disabled }
        "400": { $ref: '#/components/responses/BadRequest' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "404": { $ref: '#/components/responses/NotFound' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/security/mfa/{factorId}/enable:
    post:
      tags: [Security]
      summary: Enable an MFA factor
      description: Reactivates a previously disabled MFA factor for the signed-in user.
      operationId: enableMfaFactor
      security:
        - cookieAuth: []
          csrfHeader: []
      parameters:
        - in: path
          required: true
          name: factorId
          schema: { type: string }
          description: Identifier returned in the security snapshot
      responses:
        "204": { description: Factor enabled }
        "400": { $ref: '#/components/responses/BadRequest' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "404": { $ref: '#/components/responses/NotFound' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/security/mfa/{factorId}:
    delete:
      tags: [Security]
      summary: Delete an MFA factor
      description: Permanently removes an MFA factor and any backup codes linked to it.
      operationId: deleteMfaFactor
      security:
        - cookieAuth: []
          csrfHeader: []
      parameters:
        - in: path
          required: true
          name: factorId
          schema: { type: string }
          description: Identifier returned in the security snapshot
      responses:
        "204": { description: Factor deleted }
        "400": { $ref: '#/components/responses/BadRequest' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "404": { $ref: '#/components/responses/NotFound' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/notifications:
    get:
      tags: [Notifications]
      summary: Get the signed-in user's notification settings
      description: |
        Returns default channels, topic preferences, digest cadence, quiet hours, critical escalation targets,
        and registered devices for the authenticated user. Requires a valid session cookie.
      operationId: getNotificationSettings
      security:
        - cookieAuth: []
      responses:
        "200":
          description: Notification settings
          content:
            application/json:
              schema:
                type: object
                properties:
                  settings:
                    $ref: '#/components/schemas/NotificationSettings'
                required: [settings]
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

    put:
      tags: [Notifications]
      summary: Update notification settings
      description: |
        Persist updated channels, topic preferences, digest cadence, quiet hours, escalation targets, or registered
        devices for the signed-in user. Requires a valid session cookie plus CSRF header.
      operationId: updateNotificationSettings
      security:
        - cookieAuth: []
          csrfHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NotificationSettingsUpdateRequest'
      responses:
        "200":
          description: Updated notification settings
          content:
            application/json:
              schema:
                type: object
                properties:
                  settings:
                    $ref: '#/components/schemas/NotificationSettings'
                required: [settings]
        "400": { $ref: '#/components/responses/BadRequest' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "429": { $ref: '#/components/responses/TooManyRequests' }

  /auth/register:
    post:
      tags: [Auth]
      summary: Register a new user
      description: |
        Register a new user account. This endpoint accepts the user's name, email,
        and a password and creates a new identity in the system. It is intended for
        interactive client use (web or mobile) and performs server-side validation
        of inputs to ensure password strength and email format.

        Behavior and constraints:
        - The server will return 201 Created on success along with a minimal
          representation of the new user. Additional post-registration steps such
          as sending verification emails or creating onboarding tasks may occur.
        - The operation is protected by CSRF; callers must include the `x-csrf-token`
          header obtained from `/auth/csrf` when making browser-originated requests.
        - The endpoint avoids leaking account existence via its responses; when in
          doubt, callers should treat 400 responses as generic validation failures.
      operationId: register
      security:
        - csrfHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                email: { type: string }
                password: { type: string, format: password }
              required: [name, email, password]
            example:
              name: "Admin"
              email: "admin@example.com"
              password: "Admin123!@#"
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema:
                type: object
                properties:
                  id: { type: string }
                  email: { type: string }
                  name: { type: string }
                  emailVerified: { type: ["string", "null"], format: date-time }
        "400": { $ref: "#/components/responses/BadRequest" }
      x-codeSamples:
        - lang: curl
          label: curl
          source: |
            CSRF=$(curl -s /auth/csrf | jq -r .csrfToken)
            curl -i -X POST /auth/register \
              -H 'Content-Type: application/json' \
              -H "x-csrf-token: $CSRF" \
              --cookie "csrfToken=$CSRF" \
              -d '{"name":"Admin","email":"admin@example.com","password":"Admin123!@#"}'

  /auth/login:
    post:
      tags: [Auth]
      summary: Login with email/password
      description: |
        Authenticate a user using email and password. On successful authentication,
        the server establishes a session and issues authentication cookies (access
        and refresh tokens) while returning a JSON `AuthSuccess` payload to the
        client.

        Important notes:
        - The endpoint is CSRF-protected; include the `x-csrf-token` header for
          browser-based flows. API clients using non-browser clients should follow
          the same CSRF contract or use the OAuth endpoints instead.
        - Failed authentication attempts return 401 Unauthorized. Login attempts are
          rate-limited and may contribute to account lockout policies if repeated
          failures are detected.
      operationId: login
      security:
        - csrfHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string }
                password: { type: string, format: password }
              required: [email, password]
            example:
              email: "admin@example.com"
              password: "Admin123!@#"
      responses:
        "200": { $ref: "#/components/responses/AuthSuccess" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }
      x-codeSamples:
        - lang: curl
          label: curl
          source: |
            CSRF=$(curl -s /auth/csrf | jq -r .csrfToken)
            curl -i -X POST /auth/login \
              -H 'Content-Type: application/json' \
              -H "x-csrf-token: $CSRF" \
              --cookie "csrfToken=$CSRF" \
              -d '{"email":"admin@example.com","password":"Admin123!@#"}'

  /auth/logout:
    post:
      tags: [Auth]
      summary: Logout and revoke refresh token
      description: |
        Terminate the current authenticated session and revoke the refresh token
        associated with the session. This endpoint clears authentication cookies and
        ensures the session cannot be renewed without re-authentication.

        Implementation details:
        - The endpoint is idempotent: calling it for an already-signed-out session
          will generally return success (204 No Content).
        - A valid CSRF token is required when called from a browser context.
      operationId: logout
      security:
        - csrfHeader: []
        - cookieAuth: []
      responses:
        "204": { description: No Content }
        "401": { $ref: "#/components/responses/Unauthorized" }
      x-codeSamples:
        - lang: curl
          label: curl
          source: |
            CSRF=$(curl -s /auth/csrf | jq -r .csrfToken)
            curl -i -X POST /auth/logout \
              -H "x-csrf-token: $CSRF" \
              --cookie "csrfToken=$CSRF; refreshToken=<from login>" 

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Rotate refresh token and issue new access token
      description: |
        Exchange a valid refresh token for a new short-lived access token and
        optionally rotate the refresh token to a new value. This improves long-
        lived session security by limiting the lifetime of access tokens while
        providing seamless re-authentication.

        Security and failure modes:
        - If the refresh token is missing, expired, or revoked, the server
          responds with 401 Unauthorized and the client must prompt the user to
          re-authenticate.
        - Clients must present a valid CSRF header for this state-changing
          operation when executed from a browser.
      operationId: refresh
      security:
        - csrfHeader: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
        "401": { $ref: "#/components/responses/Unauthorized" }
      x-codeSamples:
        - lang: curl
          label: curl
          source: |
            CSRF=$(curl -s /auth/csrf | jq -r .csrfToken)
            curl -i -X POST /auth/refresh \
              -H "x-csrf-token: $CSRF" \
              --cookie "csrfToken=$CSRF; refreshToken=<from login>" 

  /auth/request-email-verification:
    post:
      tags: [Auth]
      summary: Request email verification
      description: |
        Request that the system send a verification email to the supplied address
        with a short-lived token or link to confirm ownership. To reduce the
        ability to enumerate accounts, the endpoint intentionally returns a generic
        success response even when the email is not associated with an account.
      operationId: requestEmailVerification
      security:
        - csrfHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string }
              required: [email]
            example:
              email: "user@example.com"
      responses:
        "200":
          description: Always OK (to avoid enumeration)
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                required: [ok]
        "400": { $ref: "#/components/responses/BadRequest" }
        "429": { $ref: "#/components/responses/TooManyRequests" }

  /auth/verify-email:
    post:
      tags: [Auth]
      summary: Verify email using token
      description: |
        Complete the email verification flow by validating a previously issued
        verification token. Successful verification marks the user's email as
        verified and may enable account features gated behind verified emails.

        Notes:
        - Tokens are time-limited and single-use; attempting to reuse an expired
          or consumed token will return a 400 Bad Request.
      operationId: verifyEmail
      security:
        - csrfHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token: { type: string }
              required: [token]
      responses:
        "200": { description: OK }
        "400": { $ref: "#/components/responses/BadRequest" }

  /auth/request-password-reset:
    post:
      tags: [Auth]
      summary: Request password reset email
      description: |
        Initiate a password reset by asking the system to send a secure reset
        token to the user's verified email address. The endpoint avoids leaking
        whether an account exists by returning a generic success response.

        Security:
        - Rate limiting is applied to mitigate abuse.
      operationId: requestPasswordReset
      security:
        - csrfHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email: { type: string }
              required: [email]
      responses:
        "200":
          description: Always OK (to avoid enumeration)
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                required: [ok]
        "400": { $ref: "#/components/responses/BadRequest" }
        "429": { $ref: "#/components/responses/TooManyRequests" }

  /auth/reset-password:
    post:
      tags: [Auth]
      summary: Reset password using token
      description: |
        Reset a user's password by presenting a valid reset token along with the
        new password. The server enforces password policies and invalidates the
        reset token upon successful reset.

        Important:
        - This is a state-changing operation protected by CSRF when invoked from
          browser contexts.
      operationId: resetPassword
      security:
        - csrfHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token: { type: string }
                password: { type: string, format: password }
              required: [token, password]
      responses:
        "200": { description: OK }
        "400": { $ref: "#/components/responses/BadRequest" }

  /auth/me:
    get:
      tags: [Auth]
      summary: Get current authenticated user
      description: |
        Return the authenticated user's profile and permission context. This
        endpoint is intended for client applications that need to adapt UI
        behavior based on roles, permissions, or user metadata.

        Behavior:
        - Requires a valid session cookie; responds with 401 if unauthenticated.
        - The returned payload intentionally omits sensitive secrets and tokens.
      operationId: getMe
      security:
        - cookieAuth: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  id: { type: string }
                  email: { type: string }
                  name: { type: ["string", "null"] }
                  image: { type: ["string", "null"], format: uri }
                  emailVerified: { type: ["string", "null"], format: date-time }
                  metadata:
                    type: [object, "null"]
                    additionalProperties: {}
                  roles:
                    type: array
                    items: { type: string }
                  permissions:
                    type: array
                    items: { type: string }
                  createdAt: { type: string, format: date-time }
                  updatedAt: { type: string, format: date-time }
        "401": { $ref: "#/components/responses/Unauthorized" }
    put:
      tags: [Auth]
      summary: Update current authenticated user profile
      description: |
        Update basic profile fields for the authenticated user, including display name, avatar URL,
        and optional extended metadata such as pronouns or timezone.
      operationId: updateMe
      security:
        - cookieAuth: []
        - csrfHeader: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: [string, 'null'] }
                avatarUrl: { type: [string, 'null'], format: uri }
                title: { type: [string, 'null'] }
                department: { type: [string, 'null'] }
                pronouns: { type: [string, 'null'] }
                timezone: { type: [string, 'null'] }
                locale: { type: [string, 'null'] }
                phone: { type: [string, 'null'] }
                bio: { type: [string, 'null'] }
      responses:
        "200":
          description: Updated profile
          content:
            application/json:
              schema:
                type: object
                properties:
                  id: { type: string }
                  email: { type: string }
                  name: { type: ["string", "null"] }
                  image: { type: ["string", "null"], format: uri }
                  emailVerified: { type: ["string", "null"], format: date-time }
                  metadata:
                    type: [object, "null"]
                    additionalProperties: {}
                  roles:
                    type: array
                    items: { type: string }
                  permissions:
                    type: array
                    items: { type: string }
                  createdAt: { type: string, format: date-time }
                  updatedAt: { type: string, format: date-time }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /auth/mode:
    get:
      tags: [Auth]
      summary: Diagnostics for current authentication mode
      description: |
        Return a diagnostics object describing runtime authentication configuration
        (enabled OAuth providers, whether email verification is required, session
        lifetimes, etc.). This endpoint helps clients adapt UI flows (show/hide
        registration or OAuth buttons) and is safe for unauthenticated access.
      operationId: authMode
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  providers:
                    type: object
                    additionalProperties: { type: boolean }
                  emailVerificationRequired: { type: boolean }
                  sessionMaxAgeMin: { type: number }
                required: [providers]
        "400": { $ref: "#/components/responses/BadRequest" }

  /auth/oauth/{provider}/start:
    parameters:
      - name: provider
        in: path
        required: true
        schema:
          type: string
          enum: [google, github]
        description: OAuth provider
    get:
      tags: [Auth]
      summary: Start OAuth flow for provider
      description: |
        Start an OAuth 2.0 authorization flow with the chosen provider. This
        endpoint prepares any required server-side state (PKCE, state token) and
        redirects the user agent to the external provider's authorization URL.

        Implementation notes:
        - The endpoint may return 302 to redirect the browser or 200 with helper
          data for non-browser clients.
        - The server sets a transient correlation cookie to validate the
          subsequent callback from the provider.
      operationId: oauthStart
      responses:
        "200":
          description: OK (may redirect)
        "302":
          description: Redirect to OAuth provider authorization URL
        "403": { $ref: "#/components/responses/Forbidden" }
        "500": { description: Provider not configured }

  /auth/oauth/{provider}/callback:
    parameters:
      - name: provider
        in: path
        required: true
        schema:
          type: string
          enum: [google, github]
        description: OAuth provider
      - name: code
        in: query
        required: true
        schema: { type: string }
      - name: state
        in: query
        required: true
        schema: { type: string }
    get:
      tags: [Auth]
      summary: OAuth callback handler (code exchange and login)
      description: |
        Complete the OAuth flow after the provider redirects back with an
        authorization code. The server validates returned parameters, exchanges
        the code for provider tokens, optionally provisions or links a local
        user account, and establishes a session.

        Security:
        - The server validates the `state` parameter and any PKCE exchange to
          mitigate CSRF and code injection attacks.
        - Provisioning behavior (auto-creating accounts) depends on server config
          and may require additional verification in some deployments.
      operationId: oauthCallback
      responses:
        "200": { $ref: "#/components/responses/AuthSuccess" }
        "302":
          description: >-
            Redirects to success or failure URL. Note: for some clients the same JSON body shape
            as "200" (see components.responses.AuthSuccess) may be returned instead of a redirect.
        "400": { $ref: "#/components/responses/BadRequest" }
        "500": { description: Callback error }
